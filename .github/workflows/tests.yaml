name: Donobu Papal Election Smoke Test

on:
  # May 7â€“?  | Rome (CEST) â†’ California (PDT) = â€“9â€¯h
  schedule:
    # 01:00Â PDT  (10:00Â CEST firstâ€‘morning ballot Â±30â€¯min)
    - cron: '0 1 7-14 5 *'
    # 02:30Â PDT  (12:00Â CEST combinedâ€‘morning ballots)
    - cron: '30 2 7-14 5 *'
    # 08:00Â PDT  (17:30Â CEST firstâ€‘afternoon ballot)
    - cron: '0 8 7-14 5 *'
    # 09:30Â PDT  (19:00Â CEST combinedâ€‘afternoon ballots)
    - cron: '30 9 7-14 5 *'
  workflow_dispatch: {}

jobs:
  smoke-watch:
    runs-on: ubuntu-latest
    timeout-minutes: 65          # 60â€‘min watch + 5â€‘min buffer

    steps:
      - uses: actions/checkout@v4

      # Node + npm cache
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Cache Playwright browsers (~250â€¯MB) between jobs
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-1

      - name: Install deps
        run: |
          npm ci
          npx playwright install --with-deps

      # --- minuteâ€‘byâ€‘minute loop ------------------------------------------
      - name: Watch 60â€¯minutes, test once a minute
        env:
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
          GOOGLE_GENERATIVE_AI_MODEL_NAME: 'gemini-2.0-flash'
          SELF_HEAL_TESTS_ENABLED: false
        run: |
          echo "Starting 60â€‘minute smoke watchâ€¦"
          for i in $(seq 1 60); do
            echo "â–¶ï¸  Attempt $i / 60"
            if npx playwright test --project='Desktop Chrome'; then
              echo "ğŸ‰  White smoke detected â€” stopping early."
              exit 0                      # job ends
            fi
            echo "âŒ  No white smoke yet â€” sleeping 60â€¯s"
            sleep 60
          done
          echo "ğŸ•‘  Window ended with no white smoke."
          # Make the job red so dashboard shows â€œstill no popeâ€
          exit 1
